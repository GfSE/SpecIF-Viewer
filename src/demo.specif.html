<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta http-equiv="expires" content="0" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>

<div id="app" class="noOverflow" >
	<div id="pageHeader" >
		<div id="logo" ></div>
		<div id="pageSelector" class="btn-group btn-group-md pageActions" ></div>
		<div id="spinner" ></div>
		<div id="pageTitle" class="pageTitle" ></div>
	</div>
</div>

<script type="text/javascript">

var cdn = window.location.href.substr(0,window.location.href.lastIndexOf("/")+1),
	data = '{"$schema": "https://specif.de/v1.0/schema.json","id": "P-Related-Terms","title": "Project \'Related Terms\'","resourceClasses": [{"id": "RC-ResourceTerm","title": "Resource Term","changedAt": "2020-03-01T07:59:00+01:00"}],"statementClasses": [{"id": "SC-isSpecialisationOf","title": "is a specialisation of","description": "Signifies that a term is a specialization of another, such as \'Passenger Car\' and \'Vehicle\'.","subjectClasses": ["RC-ResourceTerm"],"objectClasses": ["RC-ResourceTerm"],"changedAt": "2018-03-21T18:06:20+01:00"}],"resources": [{"id": "R-9876","title": "Vehicle","description": "Any means in or by which someone travels or something is carried or conveyed; a means of conveyance or transport. (Source: dictionary.com)","class": "RC-ResourceTerm","changedAt": "2020-03-01T07:59:00+01:00"},{"id": "R-1234","title": "Lorry","description": "Any of various conveyances running on rails, as for transporting material in a mine or factory. (Source: dictionary.com)","class": "RC-ResourceTerm","changedAt": "2020-03-01T07:59:00+01:00"}],"statements": [{"id": "S-X0lXi7lJP9DQs","class": "SC-isSpecialisationOf","subject": "R-1234","object": "R-9876","changedAt": "2020-03-01T07:59:00+01:00"}],"hierarchies": [{"id": "N-78cf736b276","resource": "R-1234","changedAt": "2020-03-01T07:59:00+01:00"},{"id": "N-78cf736b277","resource": "R-9876","changedAt": "2020-03-01T07:59:00+01:00"}]}';

app = function() {
	"use strict";
	// Check the browser type, the first test is true for IE <= 10, the second for IE 11.
	if( /MSIE |rv:11.0/i.test(navigator.userAgent) ) {
		console.error('Stopping: The web-browser Internet Explorer is not supported.');
		alert('Stopping: The web-browser Internet Explorer is not supported.');
		return;
	};

	// construct main app:
	var self = {};
	self.version = 'v0.99.8';
	self.specifVersion = '1.0';

	self.init = function() {
		// must set it here, because the language files must be read first:
		document.title = self.title = i18n.LblReader;
		// Add a global spinner with state control;
		// all actions are deactivated as long as the app is busy.
		// - 'pageActions' are at the top of the page and can be initiated independently of the app's state
		// - 'contentActions' appear on the content pane (the shown tab) depending on the app's state
		// - 'elementActions' apply to a single list entry in the content pane (tab)
		self.busy = new State({
			showWhenSet: ['#spinner'],
			hideWhenSet: ['.pageActions','.contentActions']
		//	hideWhenSet: ['.pageActions','.contentActions','.elementActions']
		});
		// Define the module hierarchy; it will be used to load the modules and to control the views later on:
		let define = {
			// Define
			// - name: the modules to load as specified in 'modules.js'
			// - loadAs: name for execution (addressable javascript object)
			// - the hierarchy of views using implicit actions hide/show or refresh
			// - the explicit actions independent of any view

			// Let's start at the top level:
			// no name, thus no additional script file will be loaded at top level
			view: '#app',
			selector: '#pageSelector',			// DOM element to choose the view of a child (top level)
			selectorType: 'btns',
			children: [{
				name: 'profileAnonymous',
				loadAs: 'me'					// the name of the controller object to construct
				// no view
			},{
				name: 'cache'
				// no view
			},{
				name: 'ioSpecif'
				// no view
			},{
				name: CONFIG.specifications,
				loadAs: 'specs',					// the name of the controller object to construct
				// This is a view of the parent:
				view: '#'+CONFIG.specifications,	// uses implicit actions show/hide
				label: i18n.BtnRead,
				selectedBy: '#selectSpecs',			// DOM element in parent's selector to choose this view
				// To control the views of the children:
				selector: '#specsSelector',			// DOM element to choose the view of a child (next level)
				selectorType: 'tabs',
				children: [{
					// nothing to load, code is contained in parent's file
					// Definitions as a view of the parent:
					view: '#'+CONFIG.objectList,	// uses implicit action refresh at parent level
					byDefault: true,				// select this view at the current level, if unspecified
					viewClass: 'content',
					label: i18n.TabDocument,
					selectedBy: '#selectDocument'	// DOM element in parent's selector to choose this view
				},{
					// nothing to load, code is contained in parent's file
					// Definitions as a view of the parent:
					view: '#'+CONFIG.relations,		// uses implicit action refresh at parent level
					viewClass: 'content',
					label: i18n.TabRelations,
					selectedBy: '#selectStatements',// DOM element in parent's selector to choose this view
					children: [{
						name: 'statementsGraph'
						// no view
					}]
				},{
					name: CONFIG.objectFilter,
					// no loadAs, so name will be used for the controller object
					// Definitions as a view of the parent:
					view: '#'+CONFIG.objectFilter,	// uses implicit action refresh at parent level
					viewClass: 'contentWide',		// whole width under control of the view
					label: i18n.TabFilter,
					selectedBy: '#selectFilters'	// DOM element in parent's selector to choose this view
				},{
					name: CONFIG.reports,
					// no loadAs, so name will be used for the controller object
					// Definitions as a view of the parent:
					view: '#'+CONFIG.reports,		// uses implicit action refresh at parent level
					viewClass: 'contentWide',		// whole width under control of the view
					label: i18n.TabReports,
					selectedBy: '#selectReports'	// DOM element in parent's selector to choose this view
				}]
			},{
				name: 'about',
				view: '#about',
				viewClass: 'contentWide',			// whole width under control of the view
				label: i18n.IcoAbout,
				selectedBy: '#selectAbout'			// DOM element in parent's selector to choose this view
			}]
		};

		// React on Browser Back/Forward buttons:
		window.addEventListener("hashchange", self.show );

		// Make sure page divs are resized, if the browser window is changed in size:
		bindResizer();

		modules.load( define, {done: function() { self.show() }} );
	};
	self.show = function() {
		// The type is valid, but it is necessary to indicated that the data is not zipped:
		self.ioSpecif.init( {mediaTypeOf: attachment2mediaType} );
		self.ioSpecif.verify( {name:'data.specif'} ); 
		
		self.busy.set();
		self.ioSpecif.toSpecif( str2ab(data) )
			.done( function(res) {
					specif.check( res )
						.then( (dta)=>{
								var opts = {
										deduplicate: true,
										addGlossary: true,
										collectProcesses: false
									};
								self.cache.create( dta, opts )
									.done( function() {
										message.show( i18n.phrase( 'MsgImportSuccessful', dta.title ), {severity:"success",duration:CONFIG.messageDisplayTimeShort} );
										setTimeout( function() {
												// change view to browse the content:
												modules.show({ newView: '#'+CONFIG.specifications /*, urlParams:urlP */ });
												self.busy.reset();
											}, 
											CONFIG.showTimelag 
										);
									})
									.fail( stdError );
							},
							stdError
						);
			})
			.fail( stdError );  
	};
	return self;
}();

	// Get two fundamental libraries in parallel, then initialize the module loader using 'modules.init' ..
	// and finally start the app using 'app.init':
	let pend=2;
	getScript( 'https://code.jquery.com/jquery-3.5.1.min.js' );
	getScript( cdn+'modules/moduleManager.js?'+app.version ); // with cache-busting on version-change
	addFavicon("shortcut icon");
	addFavicon("icon");

		// see https://www.sitepoint.com/community/t/window-load-function-getscript-not-jquery/195657/3
		function getScript(url) {
			var el = document.createElement('script');
			el.onload = function() {
							if( --pend<1 )
								modules.init( app.init, function(xhr) { alert( xhr.statusText ) }, {path:cdn} );
						};
			el.src = url;
			document.body.appendChild(el);
		}
		function addFavicon(r) {
			let link = document.createElement('link');
			link.rel = r;
			link.href = cdn+"vendor/assets/icons/favicon.ico";
			link.type = "image/x-icon";
			document.head.appendChild(link);	
		}

</script>
<noscript>
<p>The execution of JavaScript is disabled by your browser or the server.</p>
</noscript>
</body>
</html>