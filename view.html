<!DOCTYPE html>
<html>
<head>
    <title>SpecIF View</title>
	<link rel="icon" type="image/png" href="./favicon.ico">
	<meta charset="utf-8" />
	<!--<meta http-equiv="cache-control" content="no-Cache" />-->
	<meta http-equiv="expires" content="0" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>

<div id="app" class="noOverflow " >
	<div id="pageHeader" >
		<div id="logo" ></div>
		<div id="pageSelector" class="btn-group btn-group-md pageActions" ></div>
		<div id="spinner" ></div>
		<div id="pageTitle" class="pageTitle" ></div>
	</div>
</div>

<script type="text/javascript">

function App() {
	"use strict";
	// construct main app:
	var self = this;
	self.productVersion = 'v0.96.1'; // the name of the subdirectory needs to be changed, accordingly.
	self.specifVersion = '0.10.8';
	self.init = function() {
		// must set it here, because the language files must be read first:
		self.productTitle = 'SpecIF View';
		self.label = i18n.LblReader;
		document.title = self.label;
		// initialize the markdown converter:
		// ToDo: load lazily, when needed for the first time.
		if( CONFIG.convertMarkdown ) app.markdown = new showdown.Converter();
		// Add a global spinner with state control;
		// all actions are deactivated as long as the app is busy.
		// - 'pageActions' are at the top of the page and can be initiated independently of the app's state
		// - 'contentActions' appear on the content pane (the shown tab) depending on the app's state
		// - 'elementActions' apply to a single list entry in the content pane (tab)
		app.busy = new State({
			showWhenSet: ['#spinner'],
			hideWhenSet: ['.pageActions','.contentActions']
		//	hideWhenSet: ['.pageActions','.contentActions','.elementActions']
		});
		// Define the module hierarchy; it will be used to load the modules and to control the views later on:
		let define = {
			// Define 
			// - name: the modules to load as specified in 'modules.js'
			// - loadAs: name for execution (addressable javascript object) 
			// - the hierarchy of views using implicit actions hide/show or refresh
			// - the explicit actions independent of any view
			
			// Let's start at the top level:
			// no name, thus no additional script file will be loaded at top level
			view: '#app',
			selector: '#pageSelector',		// DOM element to choose the view of a child (top level)
			selectorType: 'btns',
			children: [{
				name: 'profileAnonymous',
				loadAs: 'me'					// the name of the controller object to construct
				// no view
			},{
				name: 'cache'
				// no view
			},{
				name: 'importAny',
				// no loadAs, so name will be used for the controller object
				// This is a view of the parent:
				view: '#import',				// uses implicit actions show/hide
				viewClass: 'contentWide',		// whole width under control of the view
				label: i18n.BtnImport,
				selectedBy: '#selectImport',	// DOM element in parent's selector to choose this view
				// no selector: the children don't have views
				children: [{
					name: 'ioSpecif'
					// no view
				},{
					name: 'ioReqif'
					// no view
				},{
					name: 'ioBpmn'
					// no view
				},{
					name: 'ioXls'
					// no view
				}]
			}, {
				name: CONFIG.specifications,
				loadAs: 'specs',					// the name of the controller object to construct
				// This is a view of the parent:
				view: '#'+CONFIG.specifications,	// uses implicit actions show/hide
				label: i18n.BtnRead,
				selectedBy: '#selectSpecs',			// DOM element in parent's selector to choose this view
				// To control the views of the children:
				selector: '#specsSelector',			// DOM element to choose the view of a child (next level)
				selectorType: 'tabs',
				children: [{
					// nothing to load, code is contained in parent's file
					// Definitions as a view of the parent:
					view: '#'+CONFIG.objectList,	// uses implicit action refresh at parent level
					byDefault: true,				// select this view at the current level, if unspecified
					viewClass: 'content',
					label: i18n.TabDocument,
					selectedBy: '#selectDocument'	// DOM element in parent's selector to choose this view
				},{
					// nothing to load, code is contained in parent's file
					// Definitions as a view of the parent:
					view: '#'+CONFIG.relations,		// uses implicit action refresh at parent level
					viewClass: 'content',
					label: i18n.TabRelations,
					selectedBy: '#selectStatements',	// DOM element in parent's selector to choose this view
					children: [{
						name: 'statementsGraph'
						// no view
					}]
				},{
					name: CONFIG.objectFilter,
					// no loadAs, so name will be used for the controller object
					// Definitions as a view of the parent:
					view: '#'+CONFIG.objectFilter,	// uses implicit action refresh at parent level
					viewClass: 'contentWide',		// whole width under control of the view
					label: i18n.TabFilter,
					selectedBy: '#selectFilters'	// DOM element in parent's selector to choose this view
				},{
					name: CONFIG.reports,
					// no loadAs, so name will be used for the controller object
					// Definitions as a view of the parent:
					view: '#'+CONFIG.reports,		// uses implicit action refresh at parent level
					viewClass: 'contentWide',		// whole width under control of the view
					label: i18n.TabReports,
					selectedBy: '#selectReports'	// DOM element in parent's selector to choose this view
				}]
			}, {
				action: 'app.cache.selectedProject.export()',
				label: i18n.BtnExport,
				selectedBy: '#selectExport',		// DOM element in parent's selector to initiate this action
				// no selector: the children don't have views
				children: [{
					name: 'toEpub'
					// no view
				},{
					name: 'toOxml'
					// no view
				}]
			},{
				name: 'about',
				view: '#about',
				viewClass: 'contentWide',		// whole width under control of the view
				label: i18n.IcoAbout,
				selectedBy: '#selectAbout'		// DOM element in parent's selector to choose this view
			}]
		};

//		console.debug( self.label+" will be initialized!" );

		window.addEventListener("hashchange", self.show );
		bindResizer();
		
		modules.load( define, {done:function() { self.show() }} );
		console.info( self.label+" started!" )
	};
	self.show = function() {
		self.me.read()
			.done(function() {
				var uP = getUrlParams(), v;
				if( !app.cache.selectedProject 
					|| !app.cache.selectedProject.loaded() 
					|| uP[CONFIG.keyProject] && uP[CONFIG.keyProject]!=app.cache.selectedProject.data.id 
					|| uP[CONFIG.keyImport] && uP[CONFIG.keyImport].length>0 )
					// - no project is loaded 
					// - a project id is found in the URL parameters and it differs from the one of the loaded project
					// - an URL parameter 'import' has been found:
					v = '#import'
				else
					v = '#'+ (uP[CONFIG.keyView] || CONFIG.specifications);
//				console.debug( 'app.view', uP, v );
				modules.show({newView:v,urlParams:uP});
			})
			.fail(function() {
				self.hide()
			})
	};
/*	self.hide = function() {
		// hide the app:
		// ToDo, but so far it is not called and it is not even clear what should happen ;-)
	};
	self.updateMe = function() {
		message.hide();
		self.hide();
//		me.beginUpdate()
	};
	self.logout = function() {
//		me.logout();
		self.hide();
	}; */
	return self
};
app = new App();

// Get two fundamental libraries in parallel, then initialize the module loader using 'modules.init' ..
// and finally start the app using 'app.init':
	// see https://www.sitepoint.com/community/t/window-load-function-getscript-not-jquery/195657/3
	function getScript(url, callback) {
		var el = document.createElement('script');
		el.onload = callback;
		el.src = url;
		document.body.appendChild(el)
	}
	function start() {
		if( --pend<1 ) modules.init({ done: app.init })
	}
let pend=2;
getScript('https://code.jquery.com/jquery-3.4.1.min.js', start );
getScript('./'+app.productVersion+'/modules.js', start )

</script>  
</body>
</html>